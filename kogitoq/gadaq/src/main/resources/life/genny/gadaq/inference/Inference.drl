package life.genny.gadaq.inference;

import life.genny.qwandaq.message.QDataAnswerMessage;
import life.genny.qwandaq.utils.KafkaUtils;
import life.genny.qwandaq.models.UserToken;
import life.genny.qwandaq.utils.BaseEntityUtils;
import life.genny.qwandaq.utils.CacheUtils;
import life.genny.qwandaq.models.ProcessVariables;
import life.genny.qwandaq.Answer;
import org.apache.commons.lang3.text.WordUtils;

ruleflow-group 'Inference'

rule InferenceLog 
when
	answer: Answer()
then
	String sourceCode = answer.getSourceCode();
	String targetCode = answer.getTargetCode();
	String attributeCode = answer.getAttributeCode();
	String value = answer.getValue();
	System.out.println("Inferring GENNYQ! Source Code: " + sourceCode + " Target Code: " + targetCode + " Attribute Code: " + attributeCode + " Value: " + value);
end

rule InferFirstName 
when
	answer: Answer( attributeCode == "PRI_FIRSTNAME" )
	beUtils : BaseEntityUtils()
	userToken : UserToken()
then
	System.out.println("InferFirstName fired!");
	String firstName = answer.getValue().toLowerCase().trim();
	firstName = WordUtils.capitalize(firstName);

	String processId = answer.getProcessId();
	String productCode = userToken.getProductCode();
	ProcessVariables processVariables = CacheUtils.getObject(productCode, processId+":PROCESS_BE", ProcessVariables.class);

	String lastName = processVariables.getProcessEntity().getValue("PRI_LASTNAME", null);
	if (lastName == null) {
		return;
	}
	lastName = WordUtils.capitalize(lastName);
	String name = firstName + " " + lastName;

	insert(new Answer(answer.getSourceCode(), answer.getTargetCode(), "PRI_NAME", name));
end

rule InferLastName 
when
	answer: Answer( attributeCode == "PRI_LASTNAME" )
	beUtils : BaseEntityUtils()
	userToken : UserToken()
then
	System.out.println("InferLastName fired!");
	String lastName = answer.getValue().toLowerCase().trim();
	lastName = WordUtils.capitalize(lastName);

	String processId = answer.getProcessId();
	String productCode = userToken.getProductCode();
	ProcessVariables processVariables = CacheUtils.getObject(productCode, processId+":PROCESS_BE", ProcessVariables.class);

	String firstName = processVariables.getProcessEntity().getValue("PRI_FIRSTNAME", null);
	if (firstName == null) {
		return;
	}
	firstName = WordUtils.capitalize(firstName);
	String name = firstName + " " + lastName;

	insert(new Answer(answer.getSourceCode(), answer.getTargetCode(), "PRI_NAME", name));
end
