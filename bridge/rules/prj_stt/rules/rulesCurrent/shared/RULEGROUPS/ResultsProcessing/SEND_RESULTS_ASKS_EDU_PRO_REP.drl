package life.genny.rules;
import life.genny.qwanda.message.QDataAnswerMessage;
import life.genny.models.GennyToken;
import life.genny.rules.QRules;
import life.genny.utils.BaseEntityUtils;
import life.genny.qwanda.Answer;
import life.genny.qwanda.entity.BaseEntity;
import life.genny.utils.OutputParam;
import life.genny.qwandautils.KeycloakUtils;
import java.util.UUID;
import life.genny.qwandautils.QwandaUtils;

import java.util.List;
import java.util.ArrayList;

rule "SEND_RESULTS_ASKS_EDU_PRO_REP"
    ruleflow-group 'ResultsProcessing'
    no-loop true
    salience 10
    when
	 	userToken : GennyToken (code != "PER_SERVICE" )
		serviceToken : GennyToken (code == "PER_SERVICE" )
		selectionString : String ( selectionString matches "RENDER_RESULTS_S.*" )
		output : OutputParam()
		beUtils : BaseEntityUtils()
		allowed : Allowed(code == "EDU_PRO_REP")

     then
		System.out.println(drools.getRule().getName() + ": Rule fired");
 		
		String scenario = selectionString.split(":")[0].replace("RENDER_RESULTS_S", ""); 
		String targetCode = selectionString.split(":")[1];

		BaseEntity resultBe = beUtils.getBaseEntityFromLNKAttr(targetCode, "PRI_RESULTS_BE_CODE_S"+scenario);

		String option = "_ALL";
		if (scenario.equals("1")) {
			option = "_S1";
		}
		String askGroupCode = "RESULTS_ASKS_EDU_PRO_REP"+option;

		/* SEND ASKS */
		Ask resultsAsk = VertxUtils.getObject(serviceToken.getRealm(), "", askGroupCode, Ask.class, serviceToken.getToken());
		QwandaUtils.updateAskTarget(resultsAsk, resultBe.getCode());

		if (resultsAsk != null && resultBe != null){

			String json = JsonUtils.toJson(resultsAsk);
			json = json.replaceAll("PER_SERVICE", userToken.getUserCode());

			resultsAsk = JsonUtils.fromJson(json, Ask.class);
			/* send the addItems asks */
			QDataAskMessage askMsg = new QDataAskMessage(resultsAsk);
			askMsg.setToken(userToken.getToken());
			System.out.println(drools.getRule().getName()  + " - Sending results ask grp: " + askGroupCode);
			VertxUtils.writeMsg("webcmds", askMsg);

		} else {
			System.out.println(drools.getRule().getName() + "- resultsAsk = " + resultsAsk + ", resultBe = " + resultBe);
		}
			
end
