package life.genny.gadaq;

import life.genny.qwandaq.message.QEventMessage;
import life.genny.qwandaq.models.UserToken;
import life.genny.qwandaq.utils.CacheUtils;
import life.genny.qwandaq.utils.KafkaUtils;
import life.genny.gadaq.utils.KogitoUtils;

rule RouteAuthInit 
when
	msg: QEventMessage( data.code == "AUTH_INIT" )
	userToken : UserToken()
	kogitoUtils : KogitoUtils()
then
	System.out.println("Routing AUTH_INIT!");

	// TODO: move this to bridge
	if (userToken.hasRole("test")) {
		System.out.println("Saving token for " + userToken.getUsername());
		System.out.println("Key: TOKEN:" + userToken.getUserCode() + ", Value: " + userToken.getToken());
		CacheUtils.writeCache(userToken.getProductCode(), "TOKEN:"+userToken.getUserCode(), userToken.getToken());
	}

	kogitoUtils.triggerWorkflow("authinit", msg);
	retract(msg);
end

rule RouteSubmit 
when
	msg: QEventMessage( data.code == "QUE_SUBMIT" )
	userToken : UserToken()
	kogitoUtils : KogitoUtils()
then
	System.out.println("Routing SUBMIT!");

	String processId = msg.getData().getProcessId();
	kogitoUtils.sendSignal("processquestions", processId, "submit", "");
	retract(msg);
end

/**
 * If no route exists within gadaq, the message should be 
 * sent to the project specific service.
 */
rule ForwardEvent
salience 0
when
	msg: QEventMessage()
	kogitoUtils : KogitoUtils()
then
	System.out.println("Forwarding Event Message...");

	KafkaUtils.writeMsg("forwarded_events", msg);
	retract(msg);
end

